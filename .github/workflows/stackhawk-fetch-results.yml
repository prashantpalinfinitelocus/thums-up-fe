name: "StackHawk Results Fetcher and PDF Generator"

on:
  workflow_dispatch:       # Manual trigger from GitHub UI
  schedule:
    # Run weekly on Tuesday at 2 AM UTC
    - cron: '0 2 * * 2'

jobs:
  fetch-stackhawk-results:
    name: Fetch StackHawk Scan Results
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if StackHawk API key is configured
        id: check-secret
        run: |
          if [ -z "${{ secrets.STACKHAWK_API_KEY }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "StackHawk API key not configured, skipping workflow"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Create results folder
        if: steps.check-secret.outputs.skip != 'true'
        run: mkdir -p ./results

      - name: Fetch StackHawk Scan Results
        if: steps.check-secret.outputs.skip != 'true'
        env:
          STACKHAWK_API_KEY: ${{ secrets.STACKHAWK_API_KEY }}
          APPLICATION_ID: 48441821-9fed-45c6-a88c-118908749738
        run: |
          echo "ðŸ” StackHawk Results Fetcher and PDF Generator"
          echo "=================================================="
          echo "ðŸ“¦ Application ID: $APPLICATION_ID"
          echo "ðŸ“¡ Fetching latest scan for application $APPLICATION_ID..."
          
          # Fetch the latest scan
          response=$(curl -sSL \
            -H "Authorization: Bearer $STACKHAWK_API_KEY" \
            -H "Accept: application/json" \
            "https://api.stackhawk.com/api/v1/scans/$APPLICATION_ID/latest" || echo "ERROR")
          
          if echo "$response" | grep -q "ERROR\|401\|403"; then
            echo "âŒ Error fetching scan: Authentication failed. Check your API key."
            echo "âš ï¸  No scan found. Creating empty report."
            echo "{}" > ./results/stackhawk-results.json
          else
            # Check if response contains error
            if echo "$response" | jq -e '.error' > /dev/null 2>&1; then
              echo "âŒ Error in response: $(echo "$response" | jq -r '.error // .message // "Unknown error"')"
              echo "âš ï¸  No scan found. Creating empty report."
              echo "{}" > ./results/stackhawk-results.json
            else
              echo "$response" > ./results/stackhawk-results.json
              echo "âœ… Scan results fetched successfully"
              
              # Extract scan details
              scan_id=$(echo "$response" | jq -r '.id // "N/A"')
              status=$(echo "$response" | jq -r '.status // "N/A"')
              findings_count=$(echo "$response" | jq -r '.findings | length // 0')
              
              echo "ðŸ“Š Scan ID: $scan_id"
              echo "ðŸ“ˆ Status: $status"
              echo "ðŸ” Findings: $findings_count"
            fi
          fi

      - name: Generate CSV Report
        if: steps.check-secret.outputs.skip != 'true'
        run: |
          if [ -f ./results/stackhawk-results.json ] && [ -s ./results/stackhawk-results.json ]; then
            echo "ðŸ“„ Generating CSV report..."
            jq -r '
              if .findings and (.findings | length) > 0 then
                (["id", "severity", "title", "description", "remediation", "url", "parameter", "evidence"] | @csv),
                (.findings[] | [
                  .id // "",
                  .severity // "",
                  .title // "",
                  (.description // "" | gsub("\n"; " ") | gsub("\""; "\"\"")),
                  (.remediation // "" | gsub("\n"; " ") | gsub("\""; "\"\"")),
                  .url // "",
                  .parameter // "",
                  .evidence // ""
                ] | @csv)
              else
                (["id", "severity", "title", "description", "remediation", "url", "parameter", "evidence"] | @csv)
              end
            ' ./results/stackhawk-results.json > ./results/stackhawk-results.csv
            echo "âœ… CSV report generated"
          else
            echo "âš ï¸  No data to generate CSV report"
            echo "id,severity,title,description,remediation,url,parameter,evidence" > ./results/stackhawk-results.csv
          fi

      - name: Upload StackHawk Results JSON
        if: always() && steps.check-secret.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: stackhawk-results-json
          path: ./results/stackhawk-results.json
          retention-days: 30
        continue-on-error: true

      - name: Upload StackHawk Results CSV
        if: always() && steps.check-secret.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: stackhawk-results-csv
          path: ./results/stackhawk-results.csv
          retention-days: 30
        continue-on-error: true

      - name: Display error message if API key missing
        if: steps.check-secret.outputs.skip == 'true'
        run: |
          echo "âš ï¸  StackHawk API key not configured."
          echo "Please add STACKHAWK_API_KEY secret in your GitHub repository settings."
          echo "Go to: Settings > Secrets and variables > Actions > New repository secret"

